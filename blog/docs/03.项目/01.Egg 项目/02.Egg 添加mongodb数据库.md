---
title: 添加mongoose
date: 2021-02-07 18:39:11
permalink: /pages/d7f26b/
categories:
  - 项目
  - Egg 项目
tags:
  - 
---

## egg 添加 [mongoose](https://mongoosejs.com/) 支持

1. 安装[egg-mongoose](https://www.npmjs.com/package/egg-mongoose)
```sh
npm install egg-mongoose --save
```

2. 测试连接是否成功
```js
// 在根目录新建test.js, node test.js
const mongoose = require('mongoose');
mongoose.connect('mongodb://ip/database-name');
const con = mongoose.connection;
con.on('error', console.error.bind(console, '连接数据库失败'));
con.once('open', () => {
  console.log('连接成功');
});
```

3. 配置
```js
// config/plugin.js
exports.mongoose = {
    enable: true,
    package: 'egg-mongoose',
};
```

```js
// config/config.default.js
config.mongoose = {
    url: 'mongodb://ip/database-name',
    options: {
      // 用于解决：mongoDb数据库报错问题，报错信息“current Server Discovery and Monitoring engine is deprecated, and will be removed in a future version.
      // To use the new Server Discover and Monitoring engine, pass option { useUnifiedTopology: true } to the MongoClient constructor”
      useUnifiedTopology: true,
    },
}
```

## 使用流程

1. model
```js
'use strict';

module.exports = app =>{
  const mongoose = app.mongoose;
  const Schema = mongoose.Schema;

  const UserSchema = new Schema({
    userName: {
      type: String,
      unique: true,
      required: true,
    },
  });
  return mongoose.model('User', UserSchema); 
}
```

2. server
```js
'use strict';

const Service = require('egg').Service;
class UserService extends Service {
  // 更新用户信息
  async add() {
    const {
      ctx,
    } = this;
    const result = await ctx.model.User.create({
      userName: 'huruqing',
    });
    return result;
  }
}
module.exports = UserService;
```   

3. controller
```js
'use strict';

const Controller = require('egg').Controller;

class UserController extends Controller {
  async add() {
    this.ctx.body = this.ctx.service.user.add();
  }
}

module.exports = UserController;
```   

4. router
```js
router.get('/user/add')
```


